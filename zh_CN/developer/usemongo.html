
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="MetatoCome, Workflow, Hyper Automation">
      
      
        <meta name="author" content="Lucas Kehong Liu">
      
      
        <link rel="canonical" href="https://cnshsliu.github.io/mtcdocs/zh_CN/developer/usemongo.html">
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.1.4">
    
    
      
        <title>About MongoDB - MetatoCome文档</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bb3983ee.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#about-mongodb" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MetatoCome文档" class="md-header__button md-logo" aria-label="MetatoCome文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MetatoCome文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              About MongoDB
            
          </span>
        </div>
      </div>
    </div>
    
    
      <div class="md-header__option">
        <div class="md-select">
          
          <button class="md-header__button md-icon" aria-label="Select language">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24z"/></svg>
          </button>
          <div class="md-select__inner">
            <ul class="md-select__list">
              
                <li class="md-select__item">
                  <a href="../../developer/usemongo.html" hreflang="en" class="md-select__link">
                    Default (en)
                  </a>
                </li>
                
                <li class="md-select__item">
                  <a href="../../en/developer/usemongo.html" hreflang="en" class="md-select__link">
                    English
                  </a>
                </li>
                
                <li class="md-select__item">
                  <a href="usemongo.html" hreflang="zh_CN" class="md-select__link">
                    中文
                  </a>
                </li>
                
            </ul>
          </div>
        </div>
      </div>
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../index.html" class="md-tabs__link">
      首页
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../template/concept.html" class="md-tabs__link">
        流程规划
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../process/start.html" class="md-tabs__link">
        进程管理
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../work/worklist.html" class="md-tabs__link">
        任务管理
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../about.html" class="md-tabs__link">
        设置
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../api.html" class="md-tabs__link">
        开发者
      </a>
    </li>
  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../qa.html" class="md-tabs__link">
      Q&A
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../about.html" class="md-tabs__link">
      关于我们
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MetatoCome文档" class="md-nav__button md-logo" aria-label="MetatoCome文档" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    MetatoCome文档
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        首页
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          流程规划
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="流程规划" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          流程规划
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../template/concept.html" class="md-nav__link">
        基本概念
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../template/explorer.html" class="md-nav__link">
        流程浏览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../template/designer/designer.html" class="md-nav__link">
        流程设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../template/designer/pds.html" class="md-nav__link">
        角色定义
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          进程管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="进程管理" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          进程管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../process/start.html" class="md-nav__link">
        启动一个进程
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../process/explorer.html" class="md-nav__link">
        进程浏览器
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../process/overview.html" class="md-nav__link">
        进程总览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../process/worklog.html" class="md-nav__link">
        工作记录
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../process/monitor.html" class="md-nav__link">
        进程监控器
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          任务管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="任务管理" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          任务管理
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../work/worklist.html" class="md-nav__link">
        Worklist
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../work/workpage.html" class="md-nav__link">
        Work Page
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          设置
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="设置" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          设置
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../about.html" class="md-nav__link">
        Personal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../about.html" class="md-nav__link">
        Org
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../about.html" class="md-nav__link">
        Orgchart
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../about.html" class="md-nav__link">
        List
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../account/invitation.md" class="md-nav__link">
        Invitation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../account/join.md" class="md-nav__link">
        Join Approval
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          开发者
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="开发者" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          开发者
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../api.html" class="md-nav__link">
        API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sdk.html" class="md-nav__link">
        SDK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../integration.html" class="md-nav__link">
        Integration
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../qa.html" class="md-nav__link">
        Q&A
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../about.html" class="md-nav__link">
        关于我们
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="about-mongodb">About MongoDB</h1>
<p><a href="https://www.mongodb.com/docs/manual/core/document/">Manual</a></p>
<h1 id="about-mongoose">About Mongoose</h1>
<p><a href="https://mongoosejs.com/docs/">Mongoose Manual</a></p>
<h2 id="schema">Schema</h2>
<p>定义数据库
<a href="https://mongoosejs.com/docs/guide.html#schemas">Schmes</a></p>
<h2 id="_1">数据操作</h2>
<ul>
<li>操作文档对象，而不是操作记录</li>
</ul>
<h1 id="schema-definition-with-mongoose">Schema Definition with Mongoose</h1>
<p><a href="https://mongoosejs.com/docs/schematypes.html">Schema Types</a></p>
<p>Example:</p>
<ul>
<li>例一</li>
</ul>
<pre><code>var Mongoose = require(&quot;mongoose&quot;),
  //The document structure definition
  Schema = Mongoose.Schema;

//Same fields as Parse.com
var BlockSchema = new Schema(
  {
    //一个对象参考
    doc: { type: Mongoose.Schema.Types.ObjectId, ref: &quot;Document&quot; },
    //是否必须
    etype: { type: String, required: [true, &quot;不能为空&quot;] },
    //单属性索引
    nodeid: { type: String, required: [true, &quot;不能为空&quot;], index:true },
    lastupdate: { type: Number },
    //缺省值
    lock: { type: Boolean, default: false },
    content: { type: Buffer },
    mdnote: { type: Buffer },
  },
  //自动添加时间戳  createdAt, updatedAt
  { timestamps: true }
);
//组合索引
BlockSchema.index({ doc: 1, nodeid: 1 }, { unique: true });

//mongodb中的collection(sql:table)名称, Block小写加s， db.blocks.find()
var block = Mongoose.model(&quot;Block&quot;, BlockSchema);

module.exports = block;
</code></pre>
<ul>
<li>例二</li>
</ul>
<pre><code>import Mongoose from &quot;mongoose&quot;;
const schema = new Mongoose.Schema(
  {
    tenant: { type: Mongoose.Schema.Types.ObjectId, ref: &quot;Tenant&quot; },
    rehearsal: { type: Boolean, default: false },
    who: { type: String, required: true },
    towhom: { type: String, required: true },
    //限定值的范围
    objtype: {
      type: String,
      enum: [&quot;SITE&quot;, &quot;TENANT&quot;, &quot;TEMPLATE&quot;, &quot;WORKFLOW&quot;, &quot;WORK&quot;, &quot;TODO&quot;, &quot;COMMENT&quot;],
      default: &quot;TENANT&quot;,
    },
    objid: { type: String },
    threadid: { type: String },
    //数组类型，及缺省值
    people: { type: [String], default: [] },
    content: { type: String, default: &quot;&quot; },
    //子文档
    context: {
      wfid: String,
      workid: String,
      todoid: String,
    },
    // 定类型的 子文档数组
    //attachments: { type: [ fileId: string, fileName: string }], default: [] },
    // 不定类型的 子文档数组
    //attachments: { type: [Mongoose.Schema.Types.Mixed], default: [] },
  },
  { timestamps: true }
);

export default Mongoose.model(&quot;Comment&quot;, schema);
</code></pre>
<h1 id="_2">数据操作</h1>
<h2 id="insert">INSERT 添加</h2>
<ul>
<li>new 一个对象然后 save</li>
</ul>
<pre><code>    let comment = new Comment({
      tenant: tenant,
      rehearsal: rehearsal,
      who: doer,
      towhom: toWhom,
      objtype: objtype,
      objid: objid,
      people: thePeople,
      content: content,
      context: context,
      threadid: threadid ? threadid : &quot;&quot;,
    });
    comment = await comment.save();
    // _id
    // _v:1
    //createAt, updatedAt
    //....
    comment.towhom = &quot;another people&quot;;
    await comment.save(); //upate
    // _v:2
</code></pre>
<ul>
<li>findOneAndUpdate
  <a href="https://mongoosejs.com/docs/api.html#model_Model.findOneAndUpdate">findOneAndUpdate</a></li>
</ul>
<pre><code>  let comment = await Comment.findOneAndUpdate({tenant:tenant, _id: &quot;1234&quot;},
    {$set: {towhom: 'zhangsan', ...}},
    {upsert: true, new:true});
</code></pre>
<p>cRud</p>
<h2 id="find">Find 查询</h2>
<p>findOne: null, Object, findMany: [], [object]</p>
<p>基本结构：
findOne(文档条件, 返回哪些文档属性，其它参数）
<a href="https://mongoosejs.com/docs/queries.html">Mongoose Query</a></p>
<h2 id="all-quries">All Quries</h2>
<p><a href="https://mongoosejs.com/docs/api.html#Query">Quries</a></p>
<p>exmaples: exists:</p>
<p><a href="https://mongoosejs.com/docs/api.html#query_Query-exists">Exists</a></p>
<p>find:
<a href="https://mongoosejs.com/docs/api.html#query_Query-find">Find</a>
<a href="https://mongoosejs.com/docs/api.html#query_Query-findOne">Find one</a></p>
<h2 id="where">使用 WHERE</h2>
<p><a href="https://mongoosejs.com/docs/api.html#model_Model.where">Use Where</a></p>
<h2 id="count-and-count-the-number-of-documents">Count and count the number of documents</h2>
<p><a href="https://mongoosejs.com/docs/api.html#query_Query-count">Count Documents</a></p>
<pre><code>let number = await Comment.countDocuments({author: &quot;chengaoyang@xihuanwu.com&quot;});

let cmts = await Comment.find({{author: &quot;chengaoyang@xihuanwu.com&quot;}).lean();
nubmer = cmts.length;

</code></pre>
<h2 id="using-lean">Using Lean</h2>
<p>By default, Mongoose queries return an instance of the Mongoose Document class. Documents are much heavier than vanilla JavaScript objects, because they have a lot of internal state for change tracking. Enabling the lean option tells Mongoose to skip instantiating a full Mongoose document and just give you the POJO.
<a href="https://mongoosejs.com/docs/tutorials/lean.html#using-lean">Lean</a></p>
<h2 id="skip-and-limit">Skip and limit</h2>
<p>let retObjs = await Workflow.find(filter, fields).sort(sortBy).skip(skip).limit(limit).lean();</p>
<h2 id="update">Update</h2>
<ul>
<li>方法一： 查询得出文档，修改文档属性，调用 save()</li>
<li>方法二： 使用 updated:updateOne, updateMany</li>
</ul>
<pre><code>  // Get lastName from http post
    let lastName=req.payload.lastName;
    //Build regexp: 如lastName=&quot;chen&quot;, 则 chenABC 可以， chenABCD不可以，  achenABC不可以
    let regex = new RegExp(`^${lastName}.{3}$`);
  let updatedComment = await Comment.updateMany({author: regex}, {$set:{content: &quot;byChen&quot;, num:1, author: &quot;liu&quot;} }, {new:true}).lean();
</code></pre>
<h2 id="aggrgateion-mongodb-powerful">Aggrgateion mongodb Powerful</h2>
<p>Aggregation can do many of the same things that queries can. For example, below is how you can use aggregate() to find docs where name.last = 'Ghost':</p>
<pre><code>//Query: await Person.find({'name.last': 'Ghost'});
// aggregate([])
const docs = await Person.aggregate(
[
    { $match: { 'name.last': 'Ghost' } }
]
);
</code></pre>
<p>However, just because you can use aggregate() doesn't mean you should. In general, you should use queries where possible, and only use aggregate() when you absolutely need to.</p>
<p>Unlike query results, Mongoose does not hydrate() aggregation results. Aggregation results are always POJOs, not Mongoose documents.</p>
<p>hydate() or not example:</p>
<pre><code>// 取一个Tenant
tenant = await Tenant.findOne({name: 'xihuanwu'});
let tntId = tenant._id;
//用tentId 做查询， 使用Query
 await Comment.findMany({tenant: tntId});
 or
 await Comment.findMany({tenant: new ObjectId(tntId)});
//用tentId 做查询， 使用Aggreate
 await Comment.aggregate([
  {$match:
    {'tenant': new ObjectId(tenant._id)}
  }
 ])
</code></pre>
<pre><code>const docs = await Person.aggregate([{ $match: { 'name.last': 'Ghost' } }]);

docs[0] instanceof mongoose.Document; // false
</code></pre>
<p>Also, unlike query filters, Mongoose also doesn't cast aggregation pipelines. That means you're responsible for ensuring the values you pass in to an aggregation pipeline have the correct type.</p>
<pre><code>const doc = await Person.findOne();

const idString = doc._id.toString();

// Finds the `Person`, because Mongoose casts `idString` to an ObjectId
const queryRes = await Person.findOne({ _id: idString }, {&quot;_id&quot;:0, &quot;name&quot;:0});


// Does **not** find the `Person`, because Mongoose doesn't cast aggregation
// pipelines.
const aggRes = await Person.aggregate([{ $match: { _id: idString } }])
</code></pre>
<pre><code>      let todoFilter = {status: 'ST_RUN'};
      let todoGroup = await Todo.aggregate([
        { $match: todoFilter },
        { $group: { _id: &quot;$wfid&quot;, count: { $sum: 1 } } },
      ]);

      //
      [
        { _id: &quot;wfid_1&quot;, count: 100},
        { _id: &quot;wfid_2&quot;, count: 150},
      ]
      let WfsIamIn = todoGroup.map((x) =&gt; x._id);
</code></pre>
<pre><code>Workflow:
{
_id: ObjectId,
  wfid:String,
  doc: String,
  attachments: [
    {
      serverId: String,
      realName: String
    }
  ]
}

{wfid: &quot;wfid_1&quot;, attachments: [ { serverId: '1-1', realName: 'name-1-1'}, { serverId: '1-2', realName: 'name-1-2'}]}

{wfid: &quot;wfid_2&quot;, attachments: [ { serverId: '2-1', realName: 'name-2-1'}, { serverId: '2-2', realName: 'name-2-2'}]}



找出 包含serverID= 1-2的workflow，并且，返回值中只包含1-2

    let wf = await Workflow.aggregate([
      { $match: { tenant: new Mongoose.Types.ObjectId(tenant), &quot;attachments.serverId&quot;: serverId } },
      { $project: { _id: 0, doc: 0 } },

       // {wfid: &quot;wfid_1&quot;, attachments: [ { serverId: '1-1', realName: 'name-1-1'}, { serverId: '1-2', realName: 'name-1-2'}]}

      { $unwind: &quot;$attachments&quot; },
      /*
        [
        {wfid: &quot;wfid_1&quot;, attachments: { serverId: '1-1', realName: 'name-1-1'}},
        {wfid: &quot;wfid_1&quot;, attachments: { serverId: '1-2', realName: 'name-1-2'}}
        ]
        */
      { $match: { &quot;attachments.serverId&quot;: serverId } },
      /*
      [
        {wfid: &quot;wfid_1&quot;, attachments: { serverId: '1-2', realName: 'name-1-2'}}
      ]
      */
    ]);
    if (wf[0]) {
      throw new EmpError(&quot;CANNOT_DELETE&quot;, &quot;File is used in workflow&quot;);
    }
</code></pre>
<pre><code>    let ret = await Todo.aggregate([
      { $match: filter },
      {
        //lastdays， 当前活动已经持续了多少天，如果是ST_RUN或者ST_PAUSE，跟当前时间相比；
        //否则，用updatedAt - createdAt
        $addFields: {
          lastdays: {
            $cond: {
              if: {
                $or: [{ $eq: [&quot;$status&quot;, &quot;ST_RUN&quot;] }, { $eq: [&quot;$status&quot;, &quot;ST_PAUSE&quot;] }],
              },
              then: {
                $dateDiff: { startDate: &quot;$createdAt&quot;, endDate: &quot;$$NOW&quot;, unit: &quot;day&quot; },
              },
              else: {
                $dateDiff: { startDate: &quot;$createdAt&quot;, endDate: &quot;$updatedAt&quot;, unit: &quot;day&quot; },
              },
            },
          },
        },
      },
      { $sort: sortByJson },
      { $skip: skip },
      { $limit: limit },
    ]);
</code></pre>
<pre><code>  let blkops = await BlockOp.aggregate([
    {
      $match: {doc: {$eq: Mongoose.Types.ObjectId(doc_id)}},
    },
    {
      $group: {
        _id: &quot;$userid&quot;,
        logs: {$addToSet: &quot;$nodeid&quot;},
      },
    },
    {
      $lookup: {
        from: &quot;users&quot;,
        localField: &quot;_id&quot;,
        foreignField: &quot;userid&quot;, //blockops.userid
        as: &quot;fromItems&quot;,
      },
    },
    {
      $replaceRoot: {
        newRoot: {
          $mergeObjects: [{$arrayElemAt: [&quot;$fromItems&quot;, 0]}, &quot;$$ROOT&quot;],
        },
      },
    },
    {
      $project: {
        fromItems: 0,
        pwd: 0,
      },
    },
  ]).allowDiskUse(true);
</code></pre>
<p>select block.name, user.name from block, user where block.user_id = user._id;</p>
<h2 id="populate">Populate</h2>
<p>Is not mongodb, but mongoose</p>
<p><a href="https://mongoosejs.com/docs/populate.html">Populate</a>
MongoDB has the join-like $lookup aggregation operator in versions &gt;= 3.2. Mongoose has a more powerful alternative called populate(), which lets you reference documents in other collections.</p>
<p>Population is the process of automatically replacing the specified paths in the document with document(s) from other collection(s). We may populate a single document, multiple documents, a plain object, multiple plain objects, or all objects returned from a query.</p>
<pre><code>    let result = await GoodsBuy.find(filter).populate(&quot;doc&quot;, {
      _id: 1,
      name: 1,
      pub: 1,
      desc: 1,
    });
</code></pre>
<p>GoodsBuy Scheam</p>
<pre><code>{
  &quot;goods_name&quot; String,
  &quot;doc&quot; : { type: Mongoose.Schema.Types.ObjectId, ref: &quot;MyDocument&quot; },
}
</code></pre>
<p>MyDocument Schema</p>
<pre><code>{
      name: String,
      pub: String,
      desc: String,
      url:String
      ....
}
</code></pre>
<p>Result without populate:</p>
<pre><code>{
  goods_name: &quot;goods_name_value&quot;,
  doc: doc_id;
}
</code></pre>
<p>Result with populate:</p>
<pre><code>{
  goods_name: &quot;goods_name_value&quot;,
  doc:{
    _id: &quot;..&quot;, anme: &quot;...&quot;, pub:&quot;&quot;, desc:''
  }
}
</code></pre>
<h2 id="transaction">Transaction</h2>
<p><a href="https://mongoosejs.com/docs/transactions.html#transactions-in-mongoose">Transaction</a>
Transactions are new in MongoDB 4.0 and Mongoose 5.2.0. Transactions let you execute multiple operations in isolation and potentially undo all the operations if one of them fails. This guide will get you started using transactions with Mongoose.</p>
<ul>
<li>Node.js
  npm install</li>
<li>TypeScript
  package.json dev.tsc
  npm run dev.tsc .TS -&gt; build/...js</li>
<li>Hapi -&gt; Raindrop 脚手架</li>
<li>Mongoose (MongoDB)
  CRUD</li>
<li>PM2
  pm2.json
  build/....js</li>
</ul>
<ul>
<li>Raindrop
  endpoint (url route) -&gt; handlers (method)
  POST: req.payload
  GET: req.params
  ...... Mongoose...
  return h.response(string|number|JSON);</li>
</ul>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright Lucas-Kehong-Liu, 2003-2022
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["toc.integrate", "navigation.top", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.361d90f1.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.289a2a4b.min.js"></script>
      
    
  </body>
</html>